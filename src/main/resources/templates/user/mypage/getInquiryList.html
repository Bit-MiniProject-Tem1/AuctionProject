<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/myPageLayout}">
<head>
    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/css/user/mypage/myinquiry.css}">
    </th:block>
        <th:block layout:fragment="script">

            <script th:inline="javascript">
                // 추가된 행의 개수
                let addRowCnt = 0;
                // 행 추가 시 사용자 id 입력
                const loginUser = /*[[${#authentication.principal.user}]]*/;
                // 수정모드 플래그
                let updateMode = false;
                // 삭제, 수정, 추가된 데이터를 담아줄 배열
                const changeRows = [];

                $(() => {
                    // 추가버튼 클릭 시 행 하나씩 추가
                    $("#addRowBtn").on("click", () => {
                        const today = new Date();
                        const year = today.getFullYear();
                        const month = (today.getMonth() + 1) >= 10 ? (today.getMonth() + 1) : `0${(today.getMonth() + 1)}`;
                        const date = today.getDate() >= 10 ? today.getDate() : `0${today.getDate()}`;
                        const hour = today.getHours() >= 10 ? today.getHours() : `0${today.getHours()}`;
                        const minute = today.getMinutes() >= 10 ? today.getMinutes() : `0${today.getMinutes()}`;
                        const second = today.getSeconds() >= 10 ? today.getSeconds() : `0${today.getSeconds()}`;
                        const fullDate = `${year}-${month}-${date}T${hour}:${minute}:${second}`;

                        const htmlStr = `
                        <tr>
                            <td>
                                <button type="button" id="rmAddRowBtn" onclick="fnRmAddRow(this);">-</button>
                            </td>
                            <td></td>
                            <td>
                                <input type="text" id="addInquiryTitle${addRowCnt}" name="addInquiryTitle">
                            </td>
                            <td>
                                <input type="text" id="addInquiryType${addRowCnt}" name="inquiryType" readonly>
                            </td>
                            <td>
                                <input type="text" name="inquiryRegdate" id="addInquiryRegdate${addRowCnt}" value="${fullDate}">
                            </td>
                            <td>
                                <input type="text" name="inquiryCnt" value="0">
                            </td>
                            <td>
                                <input type="text" id="addInquiryAnswer${addRowCnt}" name="inquiryAnswer" readonly>
                            </td>

                            <td style="text-align: center;" name="statusTd" id="statusTd${addRowCnt}">
                                <input type="hidden" name="addStatus" id="addStatus${addRowCnt}" value="I">
                                I
                            </td>
                        </tr>
                   `;

                        $("#inquiryTable").append(htmlStr);
                        addRowCnt++;
                    });

                    // 수정 버튼 클릭 시 수정모드 on
                    $("#updRowBtn").on("click", () => {
                        updateMode = !updateMode;

                        $("td[name='inquiryTitleTd']").html("");

                        $("td[name='inquiryTitleTd']").each(function(idx) {
                            if(updateMode) {
                                let htmlStr = `
                                <input type="text" name="uInquiryTitle" id="uInquiryTitle${idx}"
                                       value="${$(this).attr('data-new-title') == '' ? $(this).attr('data-inquiry-title') : $(this).attr('data-new-title')}"
                                       onkeyup="fnChangeTitle(this);">
                            `;

                                $(this).append(htmlStr);
                            } else {
                                let htmlStr = `
                                <a id="uInquiryTitle${idx}"
                                   href="/inquiry/inquiry-cnt/${$(this).attr('data-inquiry-no')}">
                                    ${$(this).attr('data-new-title') == '' ? $(this).attr('data-inquiry-title') : $(this).attr('data-new-title')}
                                </a>
                            `;

                                $(this).append(htmlStr);
                            }
                        });
                    });

                    // 삭제버튼 클릭 시 체크된 게시글 삭제 상태로 변경
                    $("#delRowBtn").on("click", () => {
                        $("input:checkbox[name='chk']").each(function() {
                            if($(this).is(":checked")) {
                                $("#statusTd" + $(this).val()).text("D");
                                $("#status" + $(this).val()).val("D");
                            } else {
                                if($("#status" + $(this).val()).val() == "D" ||
                                    $("#status" + $(this).val()).val() == "") {
                                    $("#statusTd" + $(this).val()).text("");
                                    $("#status" + $(this).val()).val("");
                                }
                            }
                        });
                    });

                    // 저장 버튼 클릭 시 변경된 데이터 배열에 담아서 ajax로 백엔드로 전송
                    $("#savRowBtn").on("click", () => {
                        $("input[name='status']").each(function() {
                            if($(this).val() == "U") {
                                const updinquiry = {
                                    inquiryNo: $(this).attr("data-inquiry-no"),
                                    inquiryTitle: $(this).attr("data-new-title"),
                                    inquiryStatus: "U"
                                };

                                changeRows.push(updInquiry);
                            } else if($(this).val() == "D") {
                                const delInquiry = {
                                    inquiryNo: $(this).attr("data-inquiry-no"),
                                    inquiryStatus: "D"
                                };

                                changeRows.push(delInquiry);
                            }
                        });

                        $("input[name='addStatus']").each(function(idx) {
                            if($(this).val() == "I") {
                                const addInquiry = {
                                    inquiryTitle: $("#addInquiryTitle" + idx).val(),
                                    inquiryWriter: loginUser.userId,
                                    inquiryRegdate: $("#addInquiryRegdate" + idx).val(),
                                    inquiryCnt: 0,
                                    inquiryStatus: "I"
                                }

                                changeRows.push(addInquiry);
                            }
                        });

                        console.log(JSON.stringify(changeRows));

                        $.ajax({
                            url: '/inquiry/save-inquiry-list',
                            type: 'post',
                            data: {changeRows: JSON.stringify(changeRows)},
                            success: (obj) => {
                                console.log(obj);
                                alert(obj.item.msg);
                                location.href = "/inquiry/inquiry-list";
                            },
                            error: (e) => {
                                console.log(e);
                            }
                        });
                    });
                });

                const fnRmAddRow = (btn) => {
                    $(btn).parent().parent().remove();
                    addRowCnt--;
                }

                const fnChangeTitle = (input) => {
                    if($(input).val() != $(input).parent().attr("data-inquiry-title")) {
                        $(input).parent().attr("data-new-title", $(input).val());
                        $("#statusTd" + $(input).parent().attr("data-inquiry-no")).text("U");
                        $("#status" + $(input).parent().attr("data-inquiry-no")).val("U");
                        $("#status" + $(input).parent().attr("data-inquiry-no")).attr("data-new-title", $(input).val());
                    } else {
                        $("#statusTd" + $(input).parent().attr("data-inquiry-no")).text("");
                        $("#status" + $(input).parent().attr("data-inquiry-no")).val("");
                    }
                }
            </script>
        </th:block>
    <title>마이 문의</title>
</head>
<body>
<div layout:fragment="content" class="myinquiry_container">

    <div class="myinquiry_box1">
        <h2>마이 문의</h2>
    </div>
    <form id="inquiryForm" action="/inquiry/inquiry-list" method="get">
        <table border="1" style="width: 700px; border-collapse: collapse;">
            <tr>
                <td align="right">
                    <select name="searchCondition">
                        <option value="all"
                                th:selected="${searchCondition == 'all' || searchCondition == '' ||
                                                       searchCondition == null}">전체</option>
                        <option value="title"
                                th:selected="${searchCondition == 'title'}">제목</option>
                        <option value="content"
                                th:selected="${searchCondition == 'content'}">내용</option>
                        <option value="writer"
                                th:selected="${searchCondition == 'writer'}">작성자</option>
                    </select>
                    <input type="text" name="searchKeyword" th:value="${searchKeyword }">
                    <button type="submit" id="btnSearch">검색</button>
                </td>
            </tr>
        </table>
    </form>


    <div class="myinquiry_box2">
        <table id="inquiryTable" class="table">
            <tr class="table_tr">
                <th scope="col" class="table_th1">체크</th>
                <th scope="col" class="table_th2">문의번호</th>
                <th scope="col" class="table_th3">제 목</th>
                <th scope="col" class="table_th4">문의유형</th>
                <th scope="col" class="table_th5">등록일자</th>
                <th scope="col" class="table_th6">답변상태</th>
            </tr>
        </table>


    </div>
</div>


</body>
</html>